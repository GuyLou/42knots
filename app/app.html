<!DOCTYPE html>
<!--[if IE]><![endif]-->
<!--[if IE 8 ]><html dir="ltr" lang="en" class="ie8"><![endif]-->
<!--[if IE 9 ]><html dir="ltr" lang="en" class="ie9"><![enditef]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html dir="" lang="">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>42 knots</title>
<base href="https://42knots.midrehov.com/" target="_blank">


<script src="../pub/js/jquery-2.1.1.min.js" type="text/javascript"></script>
<link href="../pub/css/3.3.5_bootstrap.min.css" rel="stylesheet" media="screen" />
<script src="../pub/js/3.3.5_bootstrap.min.js" type="text/javascript"></script>

<!-- link href="catalog/view/javascript/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" / -->
<link href="../pub/fonts/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="//fonts.googleapis.com/css?family=Open+Sans:400,400i,300,700" rel="stylesheet" type="text/css" />
<!-- link href="catalog/view/theme/default/stylesheet/stylesheet.css" rel="stylesheet" -->
<link href="../pub/fonts/42font/style.css" rel="stylesheet">

<link rel="preload" href="/pub/images/tplicons/tmplt_magazine.png" as="image" type="image/png">
<link rel="preload" href="/pub/images/tplicons/tmplt_cards.png" as="image" type="image/png">
<link rel="preload" href="/pub/images/tplicons/tmplt_landing.png" as="image" type="image/png">
<link rel="preload" href="/pub/images/tplicons/tmplt_42knots.png" as="image" type="image/png">


<link href="../pub/css/twitterstyle.css" type="text/css" rel="stylesheet" media="screen" />
<script src="../pub/js/lostandfound.js" type="text/javascript"></script>
<script src="../pub/js/popup-share.js" type="text/javascript"></script>


<!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//42knots.midrehov.com/analytics/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

<style>
    .fa-clipboard {
      pointer-events: none;
      cursor: default;
      
    }
</style>

</head>

<body>
<div class="navbar navbar-default navbar-static-top" id="topbar">

    <ul class="topbar" role="navigation">
        <li><button class="btn btn-link" id="backwardsbtn"><i class="fa fa-reply"></i><span class="notmobile">  Back</span></button></li>
        <li><button class="btn btn-link route2" routeto2="ftype=flow"  id="rtstream"><!-- i class="fa fa-home"></i --><span class="icon-bw" style="font-size: 1.32em;"></span><span class="notmobile">  Home</span></button></li>
        <li><button class="btn btn-link route2" routeto2="ftype=fbt" routeto="fbt" id="rtfbt"><i class="fa fa-film"></i><span class="notmobile"> Channels</span></button></li>
        <li><button class="btn btn-link popup-share" id="editpasswordbtn"><i class="fa fa-key"></i><span class="notmobile">  Settings</span></button></li>
        
        <li><button class="btn btn-link" id="rtout"><i class="fa fa-sign-out"></i><span class="notmobile"> Log out</span></button></li>
        <li><img src="/pub/images/rss-wifi-signal-preloader-gif.gif" style="max-height: 33px; display: none;" id="countdown"></li>
        <!-- li class="twitter__bird"><i class="fa fa-twitter"></i></li -->
        <li><form id="search"><input type="text" class="form-control-nav" id="searchi" aria-describedby="search1" name="find" placeholder="search, ## for tag search"></form></li>
        <!-- li><i class="fa fa-user-circle-o"></i></li -->
        <!-- li><button class="btn btn-link">tweet</button></li -->
    </ul>

</div>

<div class="container">
	<div class="row">
		<div class="col-sm-3">
		</div>
		<div class="col-sm-6">
			<div class="panel panel-info">
			    
                <div class="panel-heading view view-fbt" style="display: block;">
					<div class="media">
						
						<div class="media-body">
							<div class="form-group has-feedback">
								    <button id="addChannel" aria-describedby="search" class="form-control btn btn42"><i class="fa fa-film"></i></button>
							</div>
						</div>
					</div>
				</div>
			    
				<div class="panel-heading view view-item">
					<div class="media">
						<div class="media-body">
							<div class="form-group has-feedback">
								<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>
								<form action="" method="post" enctype="multipart/form-data" id="fetchform">
								    <input type="hidden" name="iaction" value="fetchurl">
								    <input type="text" class="form-control in42" id="fetch" aria-describedby="search" name="fetchurl" placeholder="Throw a url inside...">
								</form>
								<i class="fa fa-camera form-control-feedback" aria-hidden="true"></i>
								<!-- span class="glyphicon glyphicon-camera-retro form-control-feedback" aria-hidden="true"></span -->
								<span id="search2" class="sr-only">(success)</span>
							</div>
						</div>
						<a class="media-left">
							<button class="btn btn-xs btn42"><i class="fa fa-cube"></i></button>
						</a>
					</div>
				</div>
				<div class="panel-body" id="main">
                <div id="newitem0">
                    
                </div>

				</div>
			</div>

			<br>
			<br>
			<br>


			<div class="panel panel-default notmobile">
			</div>
		</div>

		<div class="col-sm-3"></div>
	</div>
</div>
<template id="start" routeto2="ftype=flow"></template>
<template id="change_password0">
    <form action="" method="post" enctype="multipart/form-data" class="change_password" id="change_password">
        <input type="hidden" name="iaction" value="password">
	    <input type="password" class="form-control in_editchannel" aria-describedby="search" name="curpass" style="background-color: beige;" value="" placeholder="current password">
	        <input type="password" class="form-control in_editchannel" aria-describedby="search" name="newpass" style="background-color: beige;" value="" placeholder="new password">
	        <div class="input-group">
		        <input type="password" class="form-control in_editimg" aria-describedby="search" name="confirm" style="background-color: beige;" value="" placeholder="confirm new password" id="confirm">
	            <span class="input-group-btn">
	                <button type="submit" class="btn btn-default btn-twitter gopass"><i class="fa fa-refresh"></i><!-- span class="glyphicon glyphicon-refresh"></span --></button>
	            </span>
            </div>
        
	</form>
    <span style="color: red;" id="errormsg"></span>
</template>
<template id="template-selector">
    <div class="social-icons" style="text-align: center; font-weight: 300; background-image: linear-gradient(rgb(255, 255, 255), rgb(240, 240, 240))">
        <ul style="list-style: none; margin: 0px 0px 5px 0px; padding: 2px; float: right;">
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button style="color: #ffe330; background: url(/pub/images/tplicons/tmplt_magazine.png); background-position: 0px 0px; background-repeat: no-repeat;background-size: 100%;width: 50px;height: 50px;/*border-radius: 50%;*/ border-width: 1px; border-color: rgb(101, 157, 189);" class="btn tmpltbtn" tmplt="magazine"></button></li>
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button style="color: #ffe330; background: url(/pub/images/tplicons/tmplt_cards.png); background-position: 0px 0px; background-repeat: no-repeat;background-size: 100%;width: 50px;height: 50px;border: 0;/*border-radius: 50%;*/ border-width: 1px;" class="btn tmpltbtn" tmplt="cards"></button></li>
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button style="color: #ffe330; background: url(/pub/images/tplicons/tmplt_landing.png); background-position: 0px 0px; background-repeat: no-repeat;background-size: 100%;width: 50px;height: 50px;border: 0;/*border-radius: 50%;*/ border-width: 1px;" class="btn tmpltbtn" tmplt="landing"></button></li>
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button style="color: #ffe330; background: url(/pub/images/tplicons/tmplt_42knots.png); background-position: 0px 0px; background-repeat: no-repeat;background-size: 100%;width: 50px;height: 50px;border: 0;/*border-radius: 50%;*/ border-width: 1px;" class="btn tmpltbtn" tmplt="42knots"></button></li>
        </ul>
        <br>
        <a href="" id="tmpltpreview">preview</a>
        <span style="color: red;" id="errormsg"></span>
    </div>
</template>
<script type="text/javascript">
	// global functions and 1st load set
	// declare and set global vars:
	    var constants = {};
	    var routetos = {
	        "fbt" : {
                "ftype" : "fbt"
	        },
	        "stream" : {
                "ftype" : "stream"
	        },
	        "flow" : {
                "ftype" : "flow"
	        },
	        "settings" : {
                "ftype" : "item"
	        },
	        "channel" : {
                "ftype" : "channel"
	        },
	        "rsearch" : {
	            "ftype" : "rsearch"
	        }
	    }
	    var routehistory = [];
	    
		var ftype = ''; // 'stream';
		var objsjson = {}; // 'https://42knots.midrehov.com/index.php?route=retailer/app/json&ftype=flow' // <b>Notice</b>: Undefined variable: feed in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>197</b>;
		var objsjson0 = {};
		var me = 0; // 1;
		/**/
		var chtypes = {

		        "me": {
		            "flow":{
		                "actions":["editbutton","templatebutton"],
		                "icon": "fa fa-rss",
		                "editfunc" : "editRetailerBtn"
		            },
		            "stream":{
		                "actions":["editbutton","templatebutton"],
		                "icon": "fa fa-boat",
		                "editfunc" : "editRetailerBtn"
		                },
		            "fbt":{
		                "actions":["editbutton","templatebutton"],
		                "icon": "fa fa-tags",
		                "editfunc" : "editFbtBtn"
		            },
		            "flows":{
		                "actions":[],
		                "icon": "fa fa-rss",
		                "editfunc" : ""
		            }
		        },
		        "notme": {
		            "flow":{
		                "actions":["followbutton"],
		                "icon": "fa fa-rss",
		                "editfunc" : ""
		            },
		            "stream":{
		                "actions":["followbutton"],
		                "icon": "fa fa-boat",
		                "editfunc" : ""
		            },
		            "fbt":{
		                "actions":[],
		                "icon": "fa fa-tags",
		                "editfunc" : ""
		            },
		            "flows":{
		                "actions":[],
		                "icon": "fa fa-rss",
		                "editfunc" : ""
		            }
		        }
		    
		};
		/**/
		var objsheader = {};
		var tagsarray = {};
		var laf = new lostandfound();
		var popup = {}; // default items
		var channelEditFunc = 'editRetailerBtn';
		var baseurl = ''; // 'https://42knots.midrehov.com/';

		// scroller vars
    	const displayamount = 20; // the items per 'page'
    	const minload = 20;
    	var currentdisplay = 0; // the total items already displayed
    	var listlength = 0; // Object.keys(cardsjson).length; // the current length of the list
    	var sliceat = 0;
    	var sliced = 0;
    	var scrolliterations = 0;
    	var bulk = 0;
    	var antibulk = -1;
        // scroller vars

		var params = routetos.stream; //  a global var, holding the current page info
		var params2 = routetos.stream; //  a global var, holding the current page info
		/*
		if (ftype == 'stream') {
            var objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
		    //var objsheader = Object.assign({}, objsjson['feed']);
            objsjson['feed'] = objsjson['feed']['items'];
		  	delete objsheader['items'];
		}
		/**/
		var itemslist = '';
		var feedlink = 'https://42knots.midrehov.com/index.php?route=retailer/app/json'; //'<b>Notice</b>: Undefined variable: feedlink in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>272</b>';
		var feedsrc = feedlink + '&ftype=' + ftype;
		var faction = '';
		var actbase = ''; //'<b>Notice</b>: Undefined variable: actobj in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>275</b>';
		var actobj = '';
		var retaileredit = ''; //'<b>Notice</b>: Undefined variable: retaileredit in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>277</b>';
		var tagsaction = '';
		const channelbase = 'https://42knots.midrehov.com/42/6x7.php?v=webapp&channel='; // baseurl + '/42/apps/cards.html?channel=';
		var ctrlr = {};

		const popupShareItem = {"attachment":"main","tmpltId" : "itemSharer"};
		const popupShareDelta = {
			    "attachment":"main",
			    "tmpltId" : "channelSharer",
                "destinations": {
                      	"webapp": {
                    		"textcolor": "#ffe330",
                    		"background": "rgb(101, 157, 189)",
                    		"fa":"mobile",
                    		"linkbase":"https://42knots.midrehov.com/42/6x7.php?v=webapp&channel=" // baseurl = '42/apps/cards.html?channel=';'
                    	},
                      	"rss": {
                    		"textcolor": "#ffffff",
                    		"background":"#ee802f",
                    		"fa":"rss",
                    		"linkbase":"https://42knots.midrehov.com/42/6x7.php?v=rss&channel=" // baseurl = '42/6x7.php?channel=';
                    	},
                      	"json": {
                    		"textcolor": "#32CD32",
                    		"background":"#000000",
                    		"fa":"file-code-o",
                    		"linkbase":"https://42knots.midrehov.com/42/6x7.php?v=json&channel=" // baseurl = '42/6x7.php?channel=';
                    	},
                    	/*
                      	"copy": {
                    		"textcolor": "#32CD32",
                    		"background":"#000000",
                    		"fa":"clipboard",
                    		"linkbase":"" // baseurl = '42/6x7.php?channel='; // $('#editpasswordbtn').on('shown.bs.popover', function () {
                    	},
                    	*/
                    	"postrss": {
                    		"textcolor": "#ffffff",
                    		"background":"#F04F23",
                    		"fa":"comment-o",
                    		"linkbase":"https://app.postrss.com/r/9711" // 'https://feedly.com/i/subscription/feed/' + baseurl + '42/6x7.php?channel='' https://feedly.com/i/subscription/feed/https://42knots.midrehov.com/42/6x7.php?channel=
                    	}
                    	/*
                    	,
                      	"mailchimp": {
                    		"textcolor": "#000000",
                    		"background":"#FFe01B",
                    		"fa":"envelope", // mailchimp
                    		"linkbase":"https://mailchimp.com/help/share-your-blog-posts-with-mailchimp/"
                    	},
                      	"flipboard": {
                    		"textcolor": "#ffffff",
                    		"background":"#e12828",
                    		"fa":"flipboard",
                    		"linkbase":"https://www.facebook.com/sharer/sharer.php?u=https://42knots.midrehov.com/42/apps/cards.html?channel="  		
                    	},
                      	"facebook": {
                    		"textcolor": "#ffffff",
                    		"background":"#3b5998",
                    		"fa":"facebook-square",
                    		"linkbase":"https://www.facebook.com/sharer/sharer.php?u=https://42knots.midrehov.com/42/apps/cards.html?channel="  		
                    	}
                    	*/
                    }
            };
		
		const fbt = {
			"func" : "drawchannel",
			"loopsobj" : "feed",
			"otype" : "fbt",
			"eventTriggers" : "fbtEventsTriggers",
			"specsFunc" : "specsFbt",
			"popupParams": popupShareDelta
		};

		const flows = {
			"func" : "drawchannel",
			"loopsobj" : "feed",
			"otype" : "fbt", // which elements shold be displayed or hidden - identical to fbt
			"eventTriggers" : "fbtEventsTriggers",
			"specsFunc" : "specsFbt",
			"popupParams": popupShareDelta
		};

		const item = {
			"func" : "drawitem",
			"loopsobj" : "feed",
			"otype" : "item",
			"eventTriggers" : "itemEventsTriggers",
			"specsFunc" : "specsItem",
			"popupParams": popupShareItem
		};
		
		const channels = {
			"func" : "drawchannel",
			"loopsobj" : "feed",
			"otype" : "fbt", // which elements shold be displayed or hidden - identical to fbt
			"eventTriggers" : "fbtEventsTriggers",
			"specsFunc" : "specsFbt",
			"popupParams": popupShareDelta
		};
		
		/*
		function validateFetch(data) {
		    if (laf.isJSON(data)) {
		        let sts = JSON.parse(data);
		        if ((typeof sts['status'] != 'undefined') && sts['status'] != 'not ok') {
		            return data;
		        }
		    }

		    // if !JSON OR sts JSON.parse(data)
		    
		    return data;
		}
		/**/
		
        //https://www.tjvantoll.com/2015/09/13/fetch-and-errors/
        /*
        function handleErrors(response) {
            if (!response.ok) {
                throw Error(response.statusText);
            }
            return response;
        }
        /**/
        //.then(handleErrors);

		function loader(ctrlr) {
		    $("[id*=popover]").remove();
			clearElemId('main');
        	currentdisplay = 0; // the total items already displayed
        	listlength = 0; // Object.keys(cardsjson).length; // the current length of the list
        	sliceat = 0;
        	sliced = 0;
    	    scrolliterations = 0;
			
			
			// loadonscrollfunctionf
			/*
			slice objsjson[ctrlr.loopsobj] at listlength, listlength + displayamount
			*/
			loopitems(objsjson[ctrlr.loopsobj],'main',ctrlr.func); /* loop through the sliced*/
			window[ctrlr.eventTriggers](bulk);
			// currentdisplay = listlength + displayamount
			listlength = Object.keys(objsjson[ctrlr.loopsobj]).length;
			scrolliterations++;
			//
			
			window[ctrlr.specsFunc]();
			displayView(ctrlr.otype);
		}
		
		function init() {
		    
		    objsjson0 = JSON.parse(JSON.stringify(objsjson));
		    objsjson0.ftype = (' ' + ftype).slice(1);

		    if (typeof objsjson['tagsarray'] != 'undefined') {
		        tagsarray = JSON.parse(JSON.stringify(objsjson['tagsarray']));
		        delete objsjson['tagsarray'];
		    }
		    
		    switch(ftype) {
        	    case 'fbt':
        		    ctrlr = channels; // fbt
        	    break;
        	    case 'item':
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
        		break;
        	    case 'channel':
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
                break;
        	    case 'flows':
        		    ctrlr = channels; // flows
                break;
        	    case 'rsearch':
        		    ctrlr = channels;
                break;                
        	    case 'stream': // obsolete, once a channel is treated
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
                break;
        	    default: // channel
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
        		break;
		    	}
		    	

		    actobj = actbase +  '&otype=' + ctrlr.otype;		    	
		    bulk = 0;
    	    antibulk = -1;
        	loader(ctrlr);
        	//popup = new popupShare(ctrlr.popupParams);
		}

    	function drawitem(item) {
    	    
    	    let defaults = {};
    	    defaults['description'] = '';
    	    defaults['profile_pic'] = '';
    	    defaults['username'] = '';
    	    defaults['retailer_full_name'] = '';
    	    
    	    item = Object.assign(defaults, item); // defaults will be run over by the item attributes. but we eliminates undefines...
    	    if (typeof item.description == 'undefined') {
              item.description = '';
            }
        var tmplt = `<div id ="item_${item.item_id}" class="sitem${item.bulk}">
        	         <div class="media media-item"><div class="media-heading" style="padding-left: 10px;">
			          <div class="media-left"><a href="#" class="route2" route2="ftype=stream&fid="${item.owner_id}><img alt="" class="media-object img-rounded" src="${item.profile_pic}" style="max-width: 32px;"></a></div>
			          <div class="media-body" style="vertical-align: middle;"><h4 class="media-heading"><span style="font-size: 70%; color:#999999; font-style: italic;">${item.username} </span> <span style="font-weight: bold;">${item.retailer_full_name}</span></h4></div></div>
						<div class="media-body"  style="padding-left: 10px;">`;
			tmplt +=        `<h4 class="media-heading"><a href="${item['link']}">`;
			tmplt += item.title + '</a></h4>';
			tmplt += `<p>${item.description}<img class="media-body-image" src="${item.image_url}" onerror="if (this.src != '/image/catalog/42/42knots.png') this.src = '/image/catalog/42/42knots.png';"></p>
			          <ul class="nav nav-pills nav-pills-custom">
			            
            			<li><button class="btn btn-link item-share${item.bulk}" id="share_item_${item.item_id}" routeto="${item['link']}"><i class="fa fa-share"></i></button></li>
        			    <li><button class="btn btn-link item-star${item.bulk}" id="star_item_${item.item_id}"><i class="fa fa-star"></i></button></li>
            			<li><button class="btn btn-link item-tag${item.bulk}" id="tag_item_${item.item_id}"><i class="fa fa-tags"></i></button></li>
            			<li><button class="btn btn-link item-trash${item.bulk}" id="trash_item_${item.item_id}"><i class="fa fa-trash"></i></button></li>
    			       </ul>
						</div>

					</div>
				</div>
    	`;
		return tmplt;

    	}
    	
    	function drawchannel(channel) {

    	    dirclass = 'directionl';
    	    if (typeof channel.language != 'undefined' && ((channel.language == 'he') || (channel.language == 'ar'))) {
              dirclass = 'directionr';
            }
            
            if (typeof channel['channel_id'] == 'undefined' || channel['channel_id'] == "null") {
                channel['channel_id'] = 0;
            }
            
            let whois = 'me';
            if(channel.owner_type != 'fbt' && channel.owner_id != me) {
                whois = 'notme';
            }
            
            let flowstring = '<div class="fcwrapper"> <span><a id="achnls_' + channel['channel_id'] + '" class="route2" routeto2="ftype=stream&fid=' + channel['owner_id'] + '" href="#"> Stream </a></span> | <span><a id="achnlf_' + channel['channel_id'] + '" class="route2" routeto2="ftype=flow&fid=' + channel['owner_id'] + '" href="#"> Flow </a></span> | <span><a id="achnlc_' + channel['channel_id'] + '" class="route2" routeto2="ftype=fbt&fid=' + channel['owner_id'] + '" href="#"> Channels </a></span><br> Following <span class="fcounter"><a id="afle_' + channel['channel_id'] + '" class="route2" routeto2="ftype=flows&flowtype=follower&fid=' + channel['owner_id'] + '" href="#">' + channel['followers'] + '</a></span> | Followers <span class="fcounter"><a id="aflr_' + channel['channel_id'] + '" class="route2" routeto2="ftype=flows&flowtype=followee&fid=' + channel['owner_id'] + '" href="#">' + channel['followees'] + '</a></span> </div>';
            
           // button bar definitions
            let btnbar = {};
            
            // editbutton
            btnbar.editbutton = `
            <li class="twPc-ArrangeSizeFit">
			<button class="btn btn-link editbtn" id="int_id_${channel['key']}">
            
							<span class="twPc-StatLabel twPc-block">Edit</span>
							<i class="fa fa-wrench"></i>
						</button>
					</li>
            `;
			
			// template button
			
            btnbar.templatebutton = `
            <li class="twPc-ArrangeSizeFit">
			<button class="btn btn-link channel-template${channel.bulk}" id="tmplt_id_${channel['channel_id']}">
							<span class="twPc-StatLabel twPc-block">Templates</span>
							<i class="fa fa-picture-o"></i>
						</button>
					</li>
            `;

            // followbutton
            if (channel.IsFl == 'fl') {
                channel.ficon = 'fa fa-user-times';
                channel.fcaption = 'unfollow';
            } else {
                channel.ficon = 'fa fa-user-plus';
                channel.fcaption = 'follow';
            }
            btnbar.followbutton = `
            <li class="twPc-ArrangeSizeFit">
			<button class="btn btn-link followbtn" id="owner_id_${channel['owner_id']}" isfl="${channel.IsFl}">
			<span class="twPc-StatLabel twPc-block">${channel.fcaption}</span>
			<i class="${channel.ficon}">
            							</i>
						</button>
					</li>
            `;
    	    let tmplt = '';            
			tmplt += '<div id="channel_' + channel['key'] + '" class="schannel' + channel.bulk + '" >';
    	    tmplt += `
			<div class="twPc-div">
			<a class="twPc-bg twPc-block">`;
    
            tmplt += ' <img id="ch_img_' + channel['key'] + '" src = "' + channel.image_url + '">';
            tmplt += `
    </a>`;
			tmplt += '<div class="twPc-avatarLink"><img alt="" src="' + channel['profile_pic'] +'" style="max-height: 64px; max-width: 64px;"></div>';
            tmplt += `
		</a>

		<div class="twPc-divUser">`;
			tmplt += '<div class="twPc-divName ' + dirclass + ' ">';
			tmplt += '	<a href="' + channel.link +'"><span id="ch_title_' + channel['key'] + '">' + channel.title +'</span></a>';
            tmplt += `
			</div>`;
			tmplt += '<div class="twPc-desc '+ dirclass +'">';
			tmplt += '<a href="'+ channel.link + '"><span id="ch_description_' + channel['key'] + '">' + channel.description +'</span></a>';
            tmplt += `
            </div>

		<!-- div class="twPc-button">`;
		    tmplt += '<a class="btn btn-xs btn42" href="' + channelbase + channel['channel_id'] + '"><i class="' + chtypes[whois][channel.owner_type]['icon'] + '"></i></a>';
            tmplt += `
		</div -->`;
		tmplt += flowstring;
		tmplt += `
		</div>

		<div class="twPc-divStats">
			<ul class="twPc-Arrange">`;
			// buttons bar

			let itemsarr = chtypes[whois][channel.owner_type]['actions'];
			itemsarr.forEach(actn => tmplt += btnbar[actn]);

            tmplt += `					
					<li class="twPc-ArrangeSizeFit view view-fbt">
					`;
			tmplt += '<button class="btn btn-link openbtn" id="open_ch_id_' + channel['channel_id'] + '" routeto="stream_ch_' + channel['channel_id'] + '">';
            tmplt += `		<span class="twPc-StatLabel twPc-block">Open</span>
							<i class="fa fa-film"></i>
						</button>
					</li>
					<li class="twPc-ArrangeSizeFit">`;
            tmplt += '<button class="btn btn-link viewsbtn channel-share' + channel.bulk + '" id="ch_share_' + channel['channel_id'] +'">';
            tmplt += `		<span class="twPc-StatLabel twPc-block">Share</span>
							<i class="fa fa-share" aria-hidden="true"></i>
						</button>
					</li>
					<li class="twPc-ArrangeSizeFit">`;
            tmplt += '<button class="btn btn-link viewsbtn channel-horn' + channel.bulk + '" id="horn_' + channel['channel_id'] + '">';
            tmplt += `		<span class="twPc-StatLabel twPc-block">Publish</span>
							<i class="fa fa-bullhorn" aria-hidden="true"></i>
						</button>
					</li>
				</ul>
			</div>
		</div>
	</div>
</div>
    	    `;
    	    return tmplt;
    	}
    	/**/
    	function drawchannel2(channel) {
    	    
    	    let tmplt = '';
    	    let flowstring = '<div class="fcwrapper"> <span><a id="achnls_' + channel['channel_id'] + '" class="route2" routeto2="ftype=stream&fid=' + channel['owner_id'] + '" href="#"> Stream </a></span> | <span><a id="achnlf_' + channel['channel_id'] + '" class="route2" routeto2="ftype=flow&fid=' + channel['owner_id'] + '" href="#"> Flow </a></span> | <span><a id="achnlc_' + channel['channel_id'] + '" class="route2" routeto2="ftype=fbt&fid=' + channel['owner_id'] + '" href="#"> Channels </a></span><br> Following <span class="fcounter"><a id="afle_' + channel['channel_id'] + '" class="route2" routeto2="ftype=flows&flowtype=follower&fid=' + channel['owner_id'] + '" href="#">' + channel['followers'] + '</a></span> | Followers <span class="fcounter"><a id="aflr_' + channel['channel_id'] + '" class="route2" routeto2="ftype=flows&flowtype=followee&fid=' + channel['owner_id'] + '" href="#">' + channel['followees'] + '</a></span> </div>';
    	    dirclass = 'directionl';
    	    if (typeof channel.language != 'undefined' && ((channel.language == 'he') || (channel.language == 'ar'))) {
              dirclass = 'directionr';
            }
            
            if (typeof channel['channel_id'] == 'undefined' || channel['channel_id'] == "null") {
                channel['channel_id'] = 0;
            }
            
            // to be imported as a part of channel
            let whois = 'me';
            if(channel.owner_type != 'fbt' && channel.owner_id != me) {
                whois = 'notme';
            }
            
            let btnbar = {};
            btnbar.editbutton = {
                "jsClass" : "editbtn",
                "idprefix" : "int_id_",
                "fafa" : "wrench",
                "wording" : "edit"
            };
            btnbar.templatebutton = {
                "jsClass" : "channel-template",
                "idprefix" : "tmplt_id_",
                "fafa" : "picture-o",
                "wording" : "templates"
            };
            btnbar.followbutton = {
                "jsClass" : "followbtn",
                "idprefix" : "owner_id_",
                "fafa" : "user-plus",
                "wording" : "follow"
            };
            btnbar.viewsbutton = {
                "jsClass" : "viewsbtn channel-horn",
                "idprefix" : "horn_",
                "fafa" : "user-bullhorn",
                "wording" : "publish"
            };
    	    let itemsarr = chtypes[channel.whois][channel.owner_type]['actions'];
    	    let btns = {};
			let btnsstr = '';
            btns['editbutton'] = `<button class="${btnbar['editbutton'].jsClass}" id="${btnbar['editbutton'].idprefix}${channel.key}"><i class="fa fa-${btnbar['editbutton'].fafa}"></i></button>`;
            btns['templatebutton'] = `<button class="${btnbar['templatebutton'].jsClass}${channel.bulk}" id="${btnbar['templatebutton'].idprefix}${channel.channel_id}"><i class="fa fa-${btnbar['templatebutton'].fafa}"></i></button>`;
            btns['followbutton'] = `<button class="${btnbar['followbutton'].jsClass}" id="${btnbar['followbutton'].idprefix}${channel.owner_id}"  isfl="${channel.IsFl}"><i class="fa fa-${btnbar['followbutton'].fafa}"></i></button>`;
    	    itemsarr.forEach(actn => btnsstr += btns[actn]);
    	    tmplt += `
                <div id="channel_${channel['key']}" class="card profile-card-2 channel2 media media-item schannel${channel.bulk}">
                    <div class="card-img-block">
                        <img class="img-fluid" src="${channel.image_url}" alt="Card image cap">
                    </div>
                    <div class="card-body pt-5">
                        <img src="${channel.profile_pic}" alt="profile-image" class="profile"/>
                        ${flowstring}                        
                        <h5 class="card-title"><a href="${channel.link}">${channel.title}</a></h5>
                        <p class="card-text">${channel.description}</p>
                        <div class="icon-block">
                            <!-- --> ${btnsstr} <!-- -->
                            <button id="ch_share_${channel['channel_id']}" class="viewsbtn channel-share${channel.bulk}" href="#"> <i class="fa fa-share"></i></button>
                            <button id="horn_${channel['channel_id']}" class="viewsbtn channel-horn${channel.bulk}" href="#"> <i class="fa fa-bullhorn"></i></button>
                            
                        </div>
                    </div>
                </div>
    	    `;
    	    return tmplt;
    	}
/**/
    	function clearElemId(elemId) {
			document.getElementById(elemId).innerHTML = '';
		}
		
		function displayView(otype) {
			const viewElems = document.getElementsByClassName('view');
			for (let i = 0; i < viewElems.length; i++) {
			    viewElems[i].style.display = "none";
			}
			
		    const disViewElems = document.getElementsByClassName('view' + '-' + otype);
			for (let i = 0; i < disViewElems.length; i++) {
			    disViewElems[i].style.display = "block";
			}
		}
		
		function loopitems(itemsjson0,elemId,func, isBottom = true) {
    		var itemslist0 = '';
    		currentdisplay += laf.isError(itemsjson0.length,0);
    		console.log("currentdisplay: " + currentdisplay + ", itemsjson0.length: " + itemsjson0.length);
    		for (key in itemsjson0) {
    		    itemsjson0[key]['key'] = key;
        	    if (typeof itemsjson0[key]['bulk'] == 'undefined') {
                  itemsjson0[key]['bulk'] = bulk;
                }
                
    			itemslist0 += window[func](itemsjson0[key]);
    		}
    		$("#" + elemId).append(itemslist0);
    		/*
    		if (isBottom) {
    		    $("#" + elemId).append(itemslist0);
    		} else {
    		    $("#" + elemId).prepend(itemslist0);
    		}
    		*/
    	}
    	
    	function dummy() {}
    	
    	function specsItem() {
    	    objsheader.bulk = antibulk;
    	    objsheader['key'] = -1;
            objsheader.whois = 'me';
            if(objsheader.owner_type != 'fbt' && objsheader.owner_id != me) {
                objsheader.whois = 'notme';
            }
    	    let header = drawchannel2(objsheader);
    	     document.body.style.background = "rgba(3, 67, 120, 1) url('" + objsheader.image_url + "') no-repeat center center fixed"; 
    	     document.body.style['background-size'] = "cover";
    	    $("#" + "main").prepend(header);
    	    let channelPopup = popupShareDelta;
    	    channelPopup.tmpltId = "channelSharer";
    	    popup2 = new popupShare(channelPopup);
    	    popup = new popupShare(popupShareItem);
    	    //popup2 = new popupShare(fbt.popupParams);
    	    channelEditFunc = 'editRetailerBtn';
    	    //channelEditFunc = chtypes[whois][channel.owner_type]['editfunc'];
    	    fbtEventsTriggers(antibulk--,popupShareItem.tmpltId,channelPopup.tmpltId);

    	}
    	
    	function specsFbt() {
    	    popup2 = new popupShare(popupShareDelta);
    	    popup = new popupShare(popupShareItem);
    	    channelEditFunc = 'editFbtBtn';
    	}
    
        function addform(itemdata) {
            var actn = '';
            var specs = '';
    	    if (typeof itemdata.otype == 'undefined') {
              return;
            }
            if (itemdata.item_id == 0) {
                actn = actobj;
                specs += '<input type="hidden" name="iaction" value="add">';
            } else {
                actn = tagsaction; //'<b>Notice</b>: Undefined variable: tagsaction in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>778</b>';  
            }
            if (typeof tagsarray[itemdata.item_id] == 'undefined') {
                var tags = '';
            } else {
                var tags = tagsarray[itemdata.item_id];
            }
            
    	var tmplt = '<div style="margin-top: 2px;box-shadow: 1px 1px 2px #888888;" class="" id="formtag_' + itemdata.item_id + '">';
    	tmplt += `
    <div class="form-group has-feedback">
    								<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>`;
    tmplt += '								<form action="'  + actn  +  '" method="post" enctype="multipart/form-data" class="tagsform" id="tagsform_id_' + itemdata.item_id + '">';
    tmplt += specs;
    tmplt += '								    <input type="hidden" name="obj_id" value="' + itemdata.item_id +'">';
    tmplt += '								    <input type="hidden" name="otype" value="' + itemdata.otype +'">';
    tmplt += '								    <input type="text" class="form-control" aria-describedby="search" name="tags" style="background-color: beige;" value="' + tags + '">';
        tmplt += `    								</form>
    								<!-- span type="submit" class="glyphicon glyphicon-tags form-control-feedback" aria-hidden="true"></span -->
    								<i type="submit" class="fa fa-tags form-control-feedback" aria-hidden="true"></i>
    							</div>
    </div>
    	`;
		return tmplt;
		
        }
		
		function editChannel(channel) {
		    if (typeof channel.iactn == 'undefined') {
              channel.iactn = 'edit';
            }
            if (typeof tagsarray[channel.owner_id] == 'undefined') {
                var tags = '';
            } else {
                var tags = tagsarray[channel.owner_id];
            }
			var tmplt = '';
			tmplt += `<div style="margin-top: 2px;box-shadow: 1px 1px 2px #888888;" class="" id="edit_channel_${channel.obj_id}">
				<div class="form-group has-feedback">
												<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>
													<form action="${channel.chaction}" method="post" enctype="multipart/form-data" class="editchform" id="editchform_id_${channel.owner_id}">
													<input type="hidden" name="iaction" value="${channel.iactn}">
													<input type="hidden" name="fbt_id" value="${channel.owner_id}">
													<input type="text" class="form-control in_editchannel" aria-describedby="search" name="tags" style="background-color: beige;" value="${tags}" placeholder="tags names, comma seperated">
													<input type="text" class="form-control in_editchannel" aria-describedby="search" name="title" style="background-color: beige;" value="${channel.title}" placeholder="Title" id="title_for_${channel.owner_id}">
													<input type="text" class="form-control in_editchannel" aria-describedby="search" name="description" style="background-color: beige;" value="${channel['description']}" placeholder="Description" id="description_for_${channel.owner_id}">
													<input type="text" class="form-control in_editchannel" aria-describedby="search" name="profile_pic" style="background-color: beige;" value="${channel.profile_pic}" placeholder="avatar Icon" id="profile_pic_for_${channel.owner_id}">
													<div class="input-group">
													    <input type="text" class="form-control in_editimg" aria-describedby="search" name="header_image" style="background-color: beige;" value="${channel.image_url}" placeholder="Channel header image url" id="img_for_${channel.owner_id}">
                                                                  <span class="input-group-btn btn42">
                                                                    <button type="button" class="btn btn-default btn-twitter submitedit btn42"><i class="fa fa-refresh"></i></button>
                                                                  </span>
                                                                </div>
                                                            </form>
												<i type="submit" class="fa fa-tags form-control-feedback" aria-hidden="true"></i>
											</div>
				</div>`;
				return tmplt;
		}

</script>
<script type="text/javascript">
    
    function routeto(elemId) {
        // global rounting function
        if (params != routetos[$("#" + elemId).attr('routeto')]) {
            params = routetos[$("#" + elemId).attr('routeto')];

        /*routeto to hold a json object with parameters: ftype, channel_id if needed*/
        /*ftype is a must, the rest are not*/
        
            ftype = params.ftype;
            document.getElementById("countdown").style.display = "block";
            let encdParams = laf.objectSerialize(params);
            feedsrc = feedlink + '&' + encdParams;
            fetch(feedsrc  /*+ '&limstart=' + listlength + '&limend=' + (listlength + displayamount*/, {
                  method: 'GET'
                })
                .then(function(response) {
                    return response.json();
                    
                })
                .then(function(json) {
        			objsjson = json; //JSON.parse(json);
        			init();
        			scrollEvents();
        			document.getElementById("countdown").style.display = "none";
        		    $("html, body").animate({
                        scrollTop: 0
                    }, 9000);
        			$("html, body").on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove", function(){
                           $("html, body").stop();
                       });
                })
                //.catch((err) => {                    routeto(rtstream);                });
            
        } 
    }
    
    /**/
    function routeto2(elemId) {
        // global rounting function
        // https://42knots.midrehov.com/index.php?route=retailer/app/json&{"ftype":"channel","fid":"39"}&limstart=0&limend=20
        let series = $("#" + elemId).attr('routeto2');
        let series2 = series.replace(new RegExp('=', 'g'), '":"');
        series2 = '{"' + series2.replace(new RegExp('&', 'g'), '","') + '"}';
        desti = JSON.parse(series2);
        if (params2 != desti) {
            params2 = desti;

        
            ftype = params2.ftype;
            document.getElementById("countdown").style.display = "block";
            feedsrc = feedlink + '&' + series;
            fetch(feedsrc  , { // + '&limstart=' + listlength + '&limend=' + (listlength + displayamount
                  method: 'GET'
                })
                .then(function(response) {
                    return response.json();
                    
                })
                .then(function(json) {
                    // fold the header and the items, case items.
                    routehistory.push(JSON.parse(JSON.stringify(objsjson0)));
                    //delete objsjson0.ftype;
        			objsjson = json; //JSON.parse(json);
        			init();
        			scrollEvents();
        			document.getElementById("countdown").style.display = "none";
        		    $("html, body").animate({
                        scrollTop: 0
                    }, 9000);
        			$("html, body").on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove", function(){
                           $("html, body").stop();
                       });
                })
                //.catch((err) => {                    routeto(rtstream);                });
            
        }
    }
    /*
    
    $('#search2').submit(function(e) {
		e.preventDefault();
	    var routetosearch = {};
	    routetosearch = JSON.parse(JSON.stringify(routetos.stream));        
        let dblhash = $("#searchi").val();
        
        if (dblhash.substring( 0, 2) == '##') {
            routetosearch.gvalue = dblhash.substring( 2, dblhash.length);
        } else {
            routetosearch.find = dblhash;
        }

        routetos.routetosearch = routetosearch;
        $("#searchi").attr("routeto","routetosearch");
	    routeto("searchi");
    });
*/

    $('#search').submit(function(e) {
		e.preventDefault();
	    var routetosearch = {};
	    
        let searchswitch = $("#searchi").val();
        //routetosearch = JSON.parse(JSON.stringify(routetos.stream));
        routetosearch = {
            "ftype" : "stream"
        };
        
        
        if (searchswitch.substring( 0, 2) == '##') {
            //routetosearch.ftype = 'stream';
            routetosearch.gvalue = searchswitch.substring( 2, searchswitch.length);
        } else if (searchswitch.substring( 0, 1) == '@') {
            routetosearch.ftype = 'rsearch';
            routetosearch = JSON.parse(JSON.stringify(routetos.rsearch));
            routetosearch.find = searchswitch.substring( 1, searchswitch.length);
        } else {
            routetosearch.find = searchswitch;
        }

        $("#searchi").attr("routeto2",laf.objectSerialize(routetosearch));
	    routeto2("searchi");
    });


</script>
<script type="text/javascript">

    var nonRecurringEventsTriggers = function() {
   
   
		$( "#fetch" ).on('paste', function () {
				 var self = this;
				  setTimeout(function(e) {
					$("#fetchform").submit()
				  }, 0);
		 
			
		});
   
		$('#fetchform').submit(function(e) {
			e.preventDefault();
			if ($("#item_0").length > 0) {
				$("#item_0").remove();
				$("#formtag_0").remove();
			}
			$.ajax({
			   type: "POST",
			   url: faction, //'<b>Notice</b>: Undefined variable: faction in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>993</b>',
			   data: $(this).serialize(),
			   dataType: "json",
			   //dataType: "text",
			   success: function(data)
			   {
			       if(laf.isJSON(data)) {
			           console.log("fetch Json !");
			       } else {
			           console.log("fetch NOT Json !");
			       }
			       console.log(data);
				   data.item_id = 0;
				   data.guid = data.url;
				   data.bulk = antibulk;
				   var newitem = drawitem(data);
				   //$("#main").prepend(newitem);
				   $(newitem).insertAfter('#channel_-1');
				   data.otype = 'item';
				   newitem = addform(data);
				   $("#item_0").append(newitem);
					$("#item_0").addClass("newObj");
				   $("#tagsform_id_0").submit( function(e) {
    					let tags0 = $("#tagsform_id_0").find('input[name="tags"]').val();
						e.preventDefault();
						var actn = $(this).attr('action');
						$.ajax({
						   type: "POST",
						   url: actn,
						   data: $(this).serialize(),
						   dataType: "json",
						   success: function(data)
						   {
								$('#formtag_0').remove();
								$("#item_0").removeClass("newObj");
								$("#item_0").attr("id","item_" + data['obj_id']);
								$("#tag_item_0").attr("id","tag_item_" + data['obj_id']);
								itemEventsTriggers(antibulk--,'itemSharer');
								tagsarray[data['obj_id']] = tags0;
								$("#fetch").val("");
						   },
							error: function(data) {
								console.log('error adding item: ' + JSON.stringify(data));
								$('#item_0').remove();
							}
							
						   });

				   });
				   
				},
				error: function(data) {
					console.log(data.responseText);
				}
				
			   });
		 });
		 
		$("#fetch").keyup(function() {

            if ($(this).val() == '') {
    			if ($("#item_0").length > 0) {
    				$("#item_0").remove();
    				$("#formtag_0").remove();
    			}
            }

        });
		 
                $("#addChannel").click(function(){
                        var myEle = document.getElementById("channel_-1");
                        if(myEle){
                            $("#channel_-1").remove();
                        } else {
        	                const newChannel = {
        	                    'iactn' : 'add',
        	                    'fbt_id' : -1,
        	                    'language' : '',
        	                    'key' : -1,
        	                    'image_url' : '',
        	                    'link' : '',
        	                    'title' : '',
        	                    'description' : '',
        	                    'bulk' : antibulk,
        	                    'chaction': actobj
        	                };
        	               var newitem = drawchannel(newChannel);
        	               $("#main").prepend(newitem);
        	               newitem = editChannel(newChannel);
        	               $("#channel_" + newChannel.fbt_id).append(newitem);
        	               // keyups
    						$("input:text.in_editchannel").on('keyup', function() {
    						    dest = $(this).attr('id').split("_");
    						    $("#ch_" + dest[0] + "_" + newChannel.fbt_id).text($(this).val());
    	    		        });
    	    		        $("input:text.in_editimg").on('keyup', function() {
    	    		            var id_ = $(this).attr('id');
    						    dest = id_.split("_");
    						    $("#ch_" + dest[0] + "_" + newChannel.fbt_id).attr("src",$(this).val());
    	    		        });
    	    		        
                    		$('#channel_-1').on('submit','.editchform',function(e) {
                    			e.preventDefault();
                    			var actn = $(this).attr('action');
                    			var fitem_id = $(this).attr('id').substring(14, $(this).attr('id').length);
                                console.log('actn: ' + actn + ',  actobj: ' + actobj);
                    			$.ajax({
                    			   type: "POST",
                    			   url: actn,
                    			   data: $(this).serialize(),
                    			   dataType: "json",
                    			   success: function(data)
                    			   {
                    			       console.log('#edit_channel_' + fitem_id + ',  before');
                        			    if (actn == actobj) {
                        			        objsjson[ctrlr.loopsobj][fitem_id] = data;
                        			        fbtEventsTriggers(antibulk--,'itemSharer','channelSharer');
                        			    }
                        			    console.log('#edit_channel_' + fitem_id);
                        				$('#editchform_id_' + fitem_id).remove();
                    			   },
                    				error: function(data) {
                    					console.log('error updating tag: ');
                    					console.log(data);
                    					$('#edit_channel_' + fitem_id).remove();
                    				}
                    				
                    			   });
                    			 
                    		 });					    

    	    		        
    	    		        $(".submitedit").on('click', function() {
    	    		            $(".editchform").submit();
    	    		        });

                        }
                });
                /**/
                $('#editpasswordbtn').on('shown.bs.popover', function () {
                    $('.change_password').on('submit',function(e) {
                    	e.preventDefault();
                    	var actn = $(this).attr('action');
                    
                    	$.ajax({
                    	   type: "POST",
                    	   url: actn,
                    	   data: $(this).serialize(),
                    	   dataType: "json",
                    	   success: function(data)
                    	   {
                    	    console.log(data);
                    		$("[id*=popover]").remove();
                    	   },
                    		error: function(data) {
                    			console.log('error updating password: ');
                    			document.getElementById('errormsg').innerHtml = data.reason;
                    			console.log(data);
                    			
                    			
                    		}
                    		
                    	   });
                    	 
                     });    
                
                });
                /**/
                $("#editpasswordbtn").popover({
                      placement: 'bottom',
                      container: 'body',
                      html: true,
                      content: function() {
                        //popup.updatePopUp($(this).attr('routeto'));
                        return document.getElementById('change_password0').innerHTML;
                        
                      }
                }); 
                
                /*
                $("#sidemenubtn").popover({
                    placement: 'bottom',
                    container: 'body',
                    html: true,
                    content: function() {
                    //popup.updatePopUp($(this).attr('routeto'));
                    return `
                        <ul class="topbar">
                            <li><button class="btn btn-link popup-share" ><i class="fa fa-key"></i><span class="notmobile">  Settings</span></button></li>
                            <li><button class="btn btn-link popup-share" ><i class="fa fa-key"></i><span class="notmobile">  Settings</span></button></li>
                        </u>
                    `;
                    }

                });
                /**/                    
        
    }
    
	var itemEventsTriggers = function( bulk = 0, popupShareId = 'itemSharer') {

		$(".sitem" + bulk).on('submit','.tagsform',function(e) {
			e.preventDefault();
			var actn = $(this).attr('action');
			var fitem_id = $(this).attr('id').substring(12, $(this).attr('id').length);
			let tags0 = $("#tagsform_id_" + fitem_id).find('input[name="tags"]').val();
			
			$.ajax({
			   type: "POST",
			   url: actn,
			   data: $(this).serialize(),
			   dataType: "json",
			   success: function(data)
			   {
				$('#formtag_' + fitem_id).remove();
				tagsarray[fitem_id] = tags0;
			   },
				error: function(data) {
					console.log('error updating tag: ' + data);
					$('#formtag_' + fitem_id).remove();
				}
				
			   });
			 
		 });


		$(".item-tag" + bulk).click(function(){
			var data = {};
			data.item_id = $(this).attr('id');
			data.item_id = data.item_id.substring(9, data.item_id.length);
			if ($("#" + "formtag_" + data.item_id).length > 0) {
				$("#" + "formtag_" + data.item_id).remove();
			} else {
				data.otype = ctrlr.otype;
				newitem = addform(data);
				let frag = document.createRange().createContextualFragment(newitem);
				document.getElementById("item_" + data.item_id).append(frag);
				//$("#item_" + data.item_id).append(newitem);
			}
		});
		
		$(".item-trash" + bulk).click(function(){
			var data = {};
			let rusure = confirm("are you sure you want to remove the item ?");
			data.item_id = $(this).attr('id');
			data.item_id = data.item_id.substring(11, data.item_id.length);

            if (rusure) {
                fetch('/?route=retailer/stream/switcher' , {
                  method: 'POST',
                  headers: new Headers({
                             'Content-Type': 'application/x-www-form-urlencoded', // <-- Specifying the Content-Type
                    }),
                    body: laf.objectSerialize(data), // body data type must match "Content-Type" header
                })
                .then(function(response) { return response.json(); })
                .then(function(json) {
                    if (json.status == 1) {
                        $("#item_" + data.item_id).remove();
                    } else {
                        console.log("failed trashing item!");
                        console.log(json);
                    }
                });

            }
            
		});
		
        $(".sitem" + bulk + " .route2").click(function(e){
            e.preventDefault();
            routeto2($(this).attr('id'));
            
        });		

        $(".item-share" + bulk).popover({
              placement: 'right',
              container: 'body',
              html: true,
              content: function() {
                popup.updatePopUp($(this).attr('routeto'));
                return document.getElementById('itemSharer').innerHTML;
              }
        });
        
/*

*/

	};

    var editRetailerBtn = function(bulk = 0,editObj) {
        			var data = {};
        			obj_id = $(editObj).attr('id');

	    		    obj_id = obj_id.substring(7, obj_id.length);
					data = objsheader;
					data.obj_id = obj_id;
					data.chaction = retaileredit;
					data.iactn = 'update';
	    		    

					if ($("#" + "edit_channel_" + data.obj_id).length > 0) {
						$("#" + "edit_channel_" + data.obj_id).remove();
					} else {
					    

						data.otype = ctrlr.otype;
						newitem = editChannel(data);
						$("#channel_" + data.obj_id).append(newitem);
						$("input:text.in_editchannel").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).text($(this).val());
	    		        });
	    		        $("input:text.in_editimg").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).attr("src",$(this).val());
	    		        });
	    		        $("input:text.in_editprofile").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).attr("src",$(this).val());
	    		        });

	    		        
	    		        $(".submitedit").on('click', function() {
	    		            $(".editchform").submit();
	    		        });
					}
        
    };

    var editFbtBtn = function(bulk = 0,editObj) {
        			var data = {};
        			obj_id = $(editObj).attr('id');

	    		    obj_id = obj_id.substring(7, obj_id.length);
					data = objsjson[ctrlr.loopsobj][obj_id];
					data.obj_id = obj_id;
					console.log('obj_id: ' + obj_id);
					data.chaction = actobj;
	    		    

					if ($("#" + "edit_channel_" + data.obj_id).length > 0) {
						$("#" + "edit_channel_" + data.obj_id).remove();
					} else {
					    

						data.otype = ctrlr.otype;
						newitem = editChannel(data);
						$("#channel_" + data.obj_id).append(newitem);
						$("input:text.in_editchannel").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).text($(this).val());
	    		        });
	    		        $("input:text.in_editimg").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).attr("src",$(this).val());
	    		        });
	    		        
	    		        $(".submitedit").on('click', function() {
	    		            $(".editchform").submit();
	    		        });
					}
    };
	
	var fbtEventsTriggers = function(bulk = 0, popupShareId = 'itemSharer',popupDeltaId = 'channelSharer') {
	            
	            var ch_id = 0;
	            
                /*$(".schannel" + bulk + " .route").click(function(e){
                    e.preventDefault();
                    routeto($(this).attr('id'));
                    
                });*/

                $(".schannel" + bulk + " .route2").click(function(e){
                    e.preventDefault();
                    routeto2($(this).attr('id'));
                });

	    		$(".schannel" + bulk + " .editbtn").click(function(e){
	    		    e.preventDefault();
	    		    window[channelEditFunc](bulk,$(this));
	    		});
	    		
	    		$(".schannel" + bulk + " .followbtn").click(function(e){
	    		    e.preventDefault();
	    		    console.log('follow or unfollow, that is the question');
	    		    let followee = $(this).attr('id'); // str.substring(3, 4);
	    		    followee = followee.substring(9, followee.length);
	    		    let ths = $(this);
	    		    let isfl =  $(this).attr('isfl');
	    		    let spanf = $(this).find("span");
	    		    let ifl = $(this).find("i");
	    		    /**/
	    		    
                    fetch('https://42knots.midrehov.com/index.php?route=retailer/flow/AddRemoveFlow', // flwunflow
                    {
                        method: "POST",
                        body: "followee=" + followee
                    })
                    .then(function(res){
                        return res.json();
                    })
                    .then(function(data){
                        if (data['status'] == 'ok') {
                            if (isfl == 'fl') {
                                console.log($("aflr_" + followee));
                                ths.attr('isfl','nfl');
                                $(ifl).attr( 'class','fa fa-user-plus');
                                spanf[0].innerHTML = 'follow';
                                $("aflr_" + followee).text += '-1';
                            } else {
                                console.log($("aflr_" + followee));
                                ths.attr('isfl','fl');
                                $(ifl).attr( 'class','fa fa-user-times');
                                spanf[0].innerHTML = 'unfollow';
                            }
                        } else {
                            console.log("not ok:");
                            console.log(data);
                        }
                    })
                    .catch(error => {
                        console.log(error);
                        })
                        /**/
                        /*
                    
	    		    			$.ajax({
                    			   type: "POST",
                    			   url: actn,
                    			   data: $(this).serialize(),
                    			   dataType: "json",
                    			   success: function(data)
                    			   {
                    
                        		       console.log('#edit_channel_' + fitem_id + ',  before');
                        		       console.log('actn: ' + actn,'actobj: ' + actobj);
                        			    if (actn == actobj) {
                        			        objsjson[ctrlr.loopsobj][fitem_id] = data;
                        			    }
                    			    //objsjson[ctrlr.loopsobj][fitem_id] = data;
                    				$('#editchform_id_' + fitem_id).remove();
                    			   },
                    				error: function(data) {
                    					console.log('error: ');
                    					console.log(data);
                    					$('#edit_channel_' + fitem_id).remove();
                    				}
                    				
                    			   });
	    		    */
	    		    
	    		});
	    		
	    		$(".schannel" + bulk + " .openbtn").click(function(){

	    		    ch_id = $(this).attr('id');
	    		    ch_id = ch_id.substring(11, ch_id.length);

	    		    var routetoch = {};
	    		    routetoch = JSON.parse(JSON.stringify(routetos.stream));
	    		    routetoch.channel_id = ch_id;
	    		    routetos.routetoch = routetoch;

	    		    $(this).attr("routeto","routetoch");
	    		    $(this).attr("routeto2","ftype=channel&fid=" + ch_id);
	    		    
	    		    routeto2($(this).attr('id'));
	    		});

                $('.schannel' +bulk).on('submit','.editchform',function(e) {
			e.preventDefault();
			var actn = $(this).attr('action');
			var fitem_id = $(this).attr('id').substring(14, $(this).attr('id').length);
			console.log('fitem_id: ' + fitem_id);

			$.ajax({
			   type: "POST",
			   url: actn,
			   data: $(this).serialize(),
			   dataType: "json",
			   success: function(data)
			   {

    		       console.log('#edit_channel_' + fitem_id + ',  before');
    		       console.log('actn: ' + actn,'actobj: ' + actobj);
    			    if (actn == actobj) {
    			        objsjson[ctrlr.loopsobj][fitem_id] = data;
    			    }
			    //objsjson[ctrlr.loopsobj][fitem_id] = data;
				$('#editchform_id_' + fitem_id).remove();
			   },
				error: function(data) {
					console.log('error: ');
					console.log(data);
					$('#edit_channel_' + fitem_id).remove();
				}
				
			   });
			 
		 });
		 
                $(".channel-horn" + bulk).popover({
                      placement: 'left',
                      container: 'body',
                      html: true,
                      content: function() {
                		ch_id = $(this).attr('id');
        	    		ch_id = ch_id.substring(5, ch_id.length);
                        popup2.updatePopUp(ch_id); // to fix. should be channel id returned from the backend
                        return document.getElementById(popupDeltaId).innerHTML;
                      }
                });
                
                $(".channel-share" + bulk).popover({  //  .on('popover', function (e) {
                //e.preventDefault();
              placement: 'right',
              container: 'body',
              html: true,
              content: function() {
              ch_id = $(this).attr('id');
              ch_id = ch_id.substring(9, ch_id.length);
                popup.updatePopUp(channelbase + ch_id); // to fix. should be channel id returned from the backend
                return document.getElementById(popupShareId).innerHTML;
              }
        });
        
                /**/
                $(".channel-template" + bulk).on('shown.bs.popover', function () {
                    $('.tmpltbtn').on('click',function(e) {
                    	e.preventDefault();
                    	let poststring = "channel_id=" + ch_id + "&ptype=template&pvalue=" + $(this).attr('tmplt');
                    	 console.log("poststring: " + ch_id);
                    /**/
                    	let actn = '/?route=retailer/channel/update';
                    
                    	$.ajax({
                    	   type: "POST",
                    	   url: actn,
                    	   data: poststring,
                    	   dataType: "json",
                    	   success: function(data)
                    	   {
                    	    console.log('yippy!');
                    	    console.log(data);
                    	    $("#tmpltpreview").attr("href",baseurl + '42/apps/' + $(this).attr('tmplt') + '.html?channel=' + ch_id);
                    	    //baseurl + '/42/apps/cards.html?channel=';
                    	    //mark button as selected: remove from all buttons the css class. add the css class to $(this)
                    	    //change the "preview" link destination and color
                    	   },
                    		error: function(data) {
                    			console.log('error: ');
                    			document.getElementById('errormsg').innerHtml = data.reason;
                    			console.log(data);
                    			
                    			
                    		}
                    		
                    	   });
                    /**/	 
                     });    
                
                });
                /**/
        
                $(".channel-template" + bulk).popover({
                      placement: 'right',
                      container: 'body',
                      html: true,
                      content: function() {
                      ch_id = $(this).attr('id');
                      ch_id = ch_id.substring(9, ch_id.length);
                        return document.getElementById('template-selector').innerHTML;
                      }
                });

	};
	
	/**/
	var scrollEvents = function() {

	    		//on scroll. no jQuery !
	    //let feedsrc = feedlink;
	    let shouldTriggerScroll = true;
        var navbar = document.getElementById("topbar");
        var sticky = 46; //topbar.offsetTop;
	    
		window.onscroll = function () {
		//window.addEventListener('onscroll',() => {
		stickMenu();
		loadOnScroll();
		} //});
		
		function draw() {
			sliceat = Math.max(Math.min(displayamount,listlength - currentdisplay),0);
			aggitems = laf.objSlice(objsjson[ctrlr.loopsobj],currentdisplay, currentdisplay + sliceat);
			bulk++;
			loopitems(aggitems,'main',ctrlr.func);
			window[ctrlr.eventTriggers](bulk);

			currentdisplay += sliceat;
			console.log("currentdisplay: " + currentdisplay + ", sliceat: " + sliceat);
			listlength += laf.isError(aggitems.length,0);
			shouldTriggerScroll = true;
    	}
    	
    	function loadOnScroll(){
			if(Math.abs(window.scrollY - (document.documentElement.scrollHeight - window.innerHeight)) < 1) {
				   // ajax call get data from server and append to the div
				   var aggitems = {};
				    console.log('listlength: ' + listlength);
				    console.log('currentdisplay: ' + currentdisplay);
				    console.log('shouldTriggerScroll: ' + shouldTriggerScroll);
					if (currentdisplay > 0) {
					    console.log('listlength - currentdisplay (should be less than 1): ' + (listlength - currentdisplay));
						if ((listlength - currentdisplay < 1) && shouldTriggerScroll) {
						    //window.scrollBy(0, -25);
                            shouldTriggerScroll = false;
                            document.getElementById("countdown").style.display = "block";
                            console.log(feedsrc  + '&limstart=' + listlength + '&limend=' + (listlength + displayamount));
                                    fetch(feedsrc  + '&limstart=' + listlength + '&limend=' + (listlength + displayamount) , {
                                      method: 'GET'
                                    })
                                    .then(function(response) { 
                                        /*
                                        if(laf.isJSON(response.text())) {
                                           console.log("scroll Json !");
                                        } else {
                                           console.log("scroll NOT Json !");
                                        }
                                        console.log(response.text());
                                        */
                                        return response.json();
                                        
                                    })
                                    .then(function(json) {
                            			// add json.items to the global object items
                            			let Unioner = {};
                            			if (ftype == 'fbt' || ftype == 'flows' || ftype == 'rsearch') {
                            			    Unioner = json['feed'];
                            			} else {
                            			    Unioner = json['feed']['items'];
                            			}
                            			objsjson[ctrlr.loopsobj] = laf.objUnionAll(objsjson[ctrlr.loopsobj],Unioner);
                            			tagsarray = laf.objUnionAll(tagsarray,json['tagsarray'],true);
                            			listlength = Object.keys(objsjson[ctrlr.loopsobj]).length; // the current length of the list
                            			// move to the function
                            		    draw();
                            		    document.getElementById("countdown").style.display = "none";
                                    });
						} else if (shouldTriggerScroll && (listlength - currentdisplay > 0)) {
						    draw();
						}
						

					}
					
			}
    	    
    	}
    	
    	function scrollFtech(isBottom = true, limstart = 0, limend = 20) {
    	    // fetch
    	    // .then if isBottom
    	        // add to bottom
    	        // fix the global display vars
    	   // else
    	        // add to top - only the delta
    	        // fix the global display vars
    	    
    	}
    	
    	/*https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_navbar_sticky*/
    	function stickMenu() {
          if (window.pageYOffset >= sticky) {
            navbar.classList.add("sticky")
          } else {
            navbar.classList.remove("sticky");
            }
    	}
    	
	};
	/**/
</script>
<script type="text/Javascript">

// gobal functions

$(window).load(function() {
	// init

    // get constantds
    fetch('https://42knots.midrehov.com/?route=retailer/app/json&ftype=constants', {
          method: 'GET'
        })
        .then(function(response) {
            return response.json();
            
        })
        .then(function(json) {
            constants = JSON.parse(JSON.stringify(json));
            setConstants(constants);
        })

	nonRecurringEventsTriggers();
	routeto2("start");


});

function setConstants(constants) {
        const getroute = '?route=';
        //ftype = constants['ftype'];
        baseurl = constants['baseurl'];
        me = constants['me'];
        
        // links set
        ftype = constants['ftype'];
        actbase = getroute + 'retailer/obj'; // constants['actbase'];
        retaileredit = getroute + 'retailer/update'; // constants['retaileredit'];
        tagsaction = getroute + 'retailer/tags/edittags'; //constants['retaileredit'];
        //feedlink = constants['feedlink'];
        faction = actbase + '&otype=item'; //constants['faction'];
        
        // attribution set
        $("#fetchform").attr('action',faction);
        $("html").attr('dir',constants['direction']);
        $("html").attr('lang',constants['lang']);
        $("base").attr('href',baseurl);
}

$("#rtout").click(function(){

    fetch('/?route=retailer/logout', {
          method: 'GET'
        })
        .then(function(response) {
            return response.json();
            
        })
        .then(function(json) {
            console.log(json);
            if (json['status'] == 'ok') {
                window.location.replace("/");
            }
        })
    
});

/*
$(".route").click(function(e){
    e.preventDefault();
    routeto($(this).attr('id'));
    
});
*/

$(".route2").click(function(e){
    e.preventDefault();
    routeto2($(this).attr('id'));
    
});

$("#backwardsbtn").click(function(){
    if (typeof routehistory !== 'undefined' && routehistory.length > 0) {

		objsjson = routehistory.pop(); //JSON.parse(json);
		ftype = (' ' + objsjson.ftype).slice(1);
		delete objsjson['ftype'];
		init();
		scrollEvents();
    }
});

$('.change_password').on('submit',function(e) {
	e.preventDefault();
	var actn = $(this).attr('action');

	$.ajax({
	   type: "POST",
	   url: actn,
	   data: $(this).serialize(),
	   dataType: "json",
	   success: function(data)
	   {
	    console.log(data);
		$("[id*=popover]").remove();
	   },
		error: function(data) {
			console.log('error updating password: ');
			document.getElementById('errormsg').innerHtml = data.reason;
			console.log(data);
			
			
		}
		
	   });
	 
 });    




</script>
</body>
</html>